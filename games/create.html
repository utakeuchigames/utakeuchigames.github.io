<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ç¬¦ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼é¢¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        h1, h2 { color: #00FFFF; border-bottom: 1px solid #00FFFF; padding-bottom: 5px; margin-top: 20px; }
        .controls, .editor-area { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"] { padding: 8px; margin-right: 15px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #00FFFF; color: #1e1e1e; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; margin-right: 10px; }
        button:hover { background-color: #00DDDD; }
        textarea { width: 100%; height: 350px; padding: 10px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-top: 10px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; }
    </style>
</head>
<body>

    <h1>ğŸ¼ éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼é¢¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

    <div class="controls">
        <h2>åŸºæœ¬æƒ…å ±è¨­å®š</h2>
        <label for="title">æ›²å:</label>
        <input type="text" id="title" value="Editor Generated Score">

        <label for="bpm">BPM:</label>
        <input type="number" id="bpm" value="160.0" step="0.1">

        <label for="startBeat">é–‹å§‹æ‹:</label>
        <input type="number" id="startBeat" value="0" step="1" title="è­œé¢ã®é–‹å§‹æ‹ (ä¾‹: 4æ‹ã§ã‚¤ãƒ³ãƒˆãƒ­ã‚’ç©ºã‘ãŸã„å ´åˆã€4ã‹ã‚‰å§‹ã‚ã‚‹)">
        
        <label for="startTime">é–‹å§‹æ™‚åˆ» (ç§’):</label>
        <input type="number" id="startTime" value="0.0" step="0.1" title="ã‚²ãƒ¼ãƒ é–‹å§‹ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆç§’">
    </div>

    <div class="editor-area">
        <h2>è­œé¢å®šç¾©ã‚¨ãƒªã‚¢ (ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¦ãã ã•ã„)</h2>
        <p>ãƒãƒ¼ãƒ„ã¯ `addTap()` ã¾ãŸã¯ `addLong()` é–¢æ•°ã‚’ä½¿ã£ã¦ã€**æ‹æ•°ãƒ™ãƒ¼ã‚¹**ã§å®šç¾©ã§ãã¾ã™ã€‚</p>
        <p>ä¾‹: `addTap(2.0, [1, 6]);` // 2æ‹ç›®ã«ãƒ¬ãƒ¼ãƒ³1ã¨6ã§åŒæ™‚æŠ¼ã—</p>
        
        <button onclick="generateAndDisplayScore()">ç”Ÿæˆã—ã¦JSONã‚’è¡¨ç¤º</button>
        <button onclick="downloadScore()">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    
    <div id="outputArea">
        <h2>ç”Ÿæˆã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿</h2>
        <textarea id="jsonOutput" readonly>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„...</textarea>
    </div>

    <script>
        // --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const NOTE_TYPE_TAP = 0;
        const NOTE_TYPE_LONG = 1;

        // ç”Ÿæˆä¸­ã®ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆ
        let currentNotes = [];
        let currentBPM = 0;
        let secPerBeat = 0;
        let startOffsetTime = 0;

        /**
         * å°æ•°ç‚¹ã‚’æŒ‡å®šã•ã‚ŒãŸæ¡æ•°ã«ä¸¸ã‚ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        // --- 2. è­œé¢å®šç¾©ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        /**
         * ã‚¿ãƒƒãƒ—ãƒãƒ¼ãƒ„ã‚’å®šç¾©ã—ã¾ã™ã€‚
         * @param {number} beat - æ›²ã®é–‹å§‹ã‹ã‚‰ã®æ‹æ•° (ä¾‹: 4.5æ‹ç›®)
         * @param {number[]} lanes - ãƒãƒ¼ãƒ„ã‚’é…ç½®ã™ã‚‹ãƒ¬ãƒ¼ãƒ³ç•ªå·ã®é…åˆ— (ä¾‹: [1, 3, 5])
         */
        function addTap(beat, lanes) {
            const time = round(startOffsetTime + (beat * secPerBeat), 4);
            lanes.forEach(lane => {
                currentNotes.push({ 
                    "time": time, 
                    "lane": lane, 
                    "type": NOTE_TYPE_TAP 
                });
            });
        }

        /**
         * ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã‚’å®šç¾©ã—ã¾ã™ã€‚
         * @param {number} start_beat - ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã®é–‹å§‹æ‹æ•°
         * @param {number} duration_beats - ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã®é•·ã• (æ‹æ•°)
         * @param {number[]} lanes - ãƒãƒ¼ãƒ„ã‚’é…ç½®ã™ã‚‹ãƒ¬ãƒ¼ãƒ³ç•ªå·ã®é…åˆ—
         */
        function addLong(start_beat, duration_beats, lanes) {
            const time = round(startOffsetTime + (start_beat * secPerBeat), 4);
            const duration_sec = round(duration_beats * secPerBeat, 4);
            
            lanes.forEach(lane => {
                currentNotes.push({ 
                    "time": time, 
                    "lane": lane, 
                    "type": NOTE_TYPE_LONG,
                    "duration": duration_sec
                });
            });
        }

        // --- 3. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯: è­œé¢ã‚’ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã™ã‚‹å ´æ‰€ ---

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã™ã‚‹è­œé¢å®šç¾©ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã€‚
         * æ‹æ•°ãƒ™ãƒ¼ã‚¹ã§å®šç¾©ã‚’è¡Œã„ã€ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         */
        function defineScorePattern(startBeat) {
            // åˆæœŸåŒ–
            currentNotes = [];
            
            // æ‹æ•°ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ã—ãŸç¾åœ¨ã®æ‹æ•°
            let currentBeat = startBeat;

            // =========================================================
            // â–¼â–¼â–¼â–¼â–¼ è­œé¢å®šç¾©ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã‹ã‚‰è¨˜è¿° â–¼â–¼â–¼â–¼â–¼
            // =========================================================
            
            // 1. ã‚¤ãƒ³ãƒˆãƒ­ 4æ‹å¾…æ©Ÿ (startBeatã§ã‚«ãƒãƒ¼ã•ã‚Œã‚‹)
            
            // --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ A: äº¤äº’é€£æ‰“ ---
            
            // 1æ‹ã”ã¨ã«ãƒ¬ãƒ¼ãƒ³1ã¨6ã‚’äº¤äº’ã«ã‚¿ãƒƒãƒ— (4æ‹åˆ†)
            currentBeat += 1.0; addTap(currentBeat, [1]);
            currentBeat += 1.0; addTap(currentBeat, [6]);
            currentBeat += 1.0; addTap(currentBeat, [1]);
            currentBeat += 1.0; addTap(currentBeat, [6]);
            
            // --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ B: éšæ®µ (1/4æ‹) ---
            
            currentBeat += 1.0; // 1æ‹ç©ºã‘ã‚‹
            
            for (let i = 0; i < 6; i++) {
                currentBeat += 0.25; // 1/4æ‹
                addTap(currentBeat, [i + 1]);
            }
            
            // --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ C: ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ (åŒæ™‚æŠ¼ã—) ---
            
            currentBeat += 1.75; // 1.75æ‹ç©ºã‘ã‚‹
            
            // 3æ‹ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã‚’ãƒ¬ãƒ¼ãƒ³2ã¨5ã«åŒæ™‚é…ç½®
            const longDurationBeats = 3.0;
            addLong(currentBeat, longDurationBeats, [2, 5]);

            // ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã®é ­æ‰“ã¡ã¨åŒæ™‚ã«ã‚¿ãƒƒãƒ—ãƒãƒ¼ãƒ„
            addTap(currentBeat, [1, 6]);

            // ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã®é€”ä¸­ã®ã‚¿ãƒƒãƒ— (1.5æ‹ç›®)
            addTap(currentBeat + 1.5, [3, 4]);

            currentBeat += longDurationBeats; // ãƒ­ãƒ³ã‚°ãƒãƒ¼ãƒ„ã®é•·ã•åˆ†ã€æ™‚é–“ã‚’é€²ã‚ã‚‹
            
            // --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ D: è¤‡åˆ ---
            currentBeat += 2.0; // 2æ‹ç©ºã‘ã‚‹

            // 1æ‹ã”ã¨ã«2ãƒ¬ãƒ¼ãƒ³åŒæ™‚ã‚¿ãƒƒãƒ—
            for (let i = 0; i < 4; i++) {
                currentBeat += 1.0;
                addTap(currentBeat, [2, 5]);
            }

            // =========================================================
            // â–²â–²â–²â–²â–² è­œé¢å®šç¾©ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã¾ã§è¨˜è¿° â–²â–²â–²â–²â–²
            // =========================================================

            // ãƒãƒ¼ãƒ„ã‚’æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
            currentNotes.sort((a, b) => a.time - b.time);

            return currentNotes;
        }


        // --- 4. UIé€£æºã¨ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ› ---

        function generateAndDisplayScore() {
            const title = document.getElementById('title').value;
            currentBPM = parseFloat(document.getElementById('bpm').value);
            const startBeat = parseFloat(document.getElementById('startBeat').value);
            startOffsetTime = parseFloat(document.getElementById('startTime').value);
            
            if (isNaN(currentBPM) || currentBPM <= 0) {
                alert('BPMã«ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            secPerBeat = 60.0 / currentBPM;

            try {
                const notes = defineScorePattern(startBeat);
                
                const scoreData = {
                    "song_title": title,
                    "bpm": currentBPM,
                    "notes": notes
                };
                
                const jsonString = JSON.stringify(scoreData, null, 4);
                
                document.getElementById('jsonOutput').value = jsonString;
                console.log("ã‚¹ã‚³ã‚¢ç”Ÿæˆå®Œäº†:", scoreData);

            } catch (error) {
                document.getElementById('jsonOutput').value = `[ERROR] è­œé¢å®šç¾©ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}`;
                console.error("ã‚¹ã‚³ã‚¢ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                alert(`ã‚¹ã‚³ã‚¢ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        function downloadScore() {
            const jsonString = document.getElementById('jsonOutput').value;
            if (!jsonString || jsonString.includes("ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦") || jsonString.includes("[ERROR]")) {
                alert("å…ˆã«æœ‰åŠ¹ãªã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const title = document.getElementById('title').value.replace(/[^a-z0-9]/gi, '_');
            const filename = `${title}_score.json`;
            
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ãƒ•ã‚¡ã‚¤ãƒ« '${filename}' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
        }
        
    </script>

</body>
</html>
