<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (Jummboxé¢¨å¼·åŒ–ç‰ˆ)</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        h1, h2 { color: #00FFFF; border-bottom: 1px solid #00FFFF; padding-bottom: 5px; margin-top: 20px; }
        .controls, .editor-area { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .input-group { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;}
        .note-input-grid { display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 10px; align-items: end; margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #00FFFF; color: #1e1e1e; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #00DDDD; }
        .util-btn { padding: 8px 10px; background-color: #6a5acd; color: white; margin-top: 0; }
        .util-btn:hover { background-color: #5a4bba; }

        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-top: 10px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; }
        #noteList { max-height: 250px; overflow-y: auto; background: #3c3c3c; padding: 10px; border-radius: 4px; border: 1px solid #555; }
        .note-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #555; font-size: 14px; }
        .note-item:last-child { border-bottom: none; }
        .delete-btn, .copy-btn { padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-left: 10px; margin-top: 0;}
        .delete-btn { background: #ff4d4d; color: white; }
        .copy-btn { background: #5bc0de; color: white; }
    </style>
</head>
<body>

    <h1>ğŸ¹ éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (Jummboxé¢¨å¼·åŒ–ç‰ˆ)</h1>

    <div class="controls">
        <h2>åŸºæœ¬æƒ…å ±è¨­å®š</h2>
        <div class="input-group">
            <div>
                <label for="title">æ›²å:</label>
                <input type="text" id="title" value="Enhanced Editor Score">
            </div>
            <div>
                <label for="bpm">BPM:</label>
                <input type="number" id="bpm" value="160.0" step="0.1">
            </div>
            <div>
                <label for="beatsPerMeasure">æ‹å­ (1å°ç¯€ã‚ãŸã‚Šã®æ‹æ•°)</label>
                <input type="number" id="beatsPerMeasure" value="4" min="1" step="1">
            </div>
        </div>
    </div>

    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„è¿½åŠ </h2>
        
        <div class="input-group">
            <div>
                <label for="inputMeasure">å°ç¯€ (Measure)</label>
                <input type="number" id="inputMeasure" value="1" min="1" step="1" onchange="updateBeatFromMeasure()">
            </div>
            <div>
                <label for="inputBeatInMeasure">æ‹å­å†…ã®æ‹ (1 - N)</label>
                <input type="number" id="inputBeatInMeasure" value="1.0" min="1" step="0.25" onchange="updateBeatFromMeasure()">
            </div>
            <div style="width: 150px;">
                <label for="inputBeat">çµ¶å¯¾æ‹æ•° (Beat)</label>
                <input type="number" id="inputBeat" value="4.0" step="0.25" onchange="updateMeasureFromBeat()">
            </div>
        </div>
        
        <div class="input-group">
            <button class="util-btn" onclick="advanceBeat(0.25)">+ 1/16</button>
            <button class="util-btn" onclick="advanceBeat(0.5)">+ 1/8</button>
            <button class="util-btn" onclick="advanceBeat(1.0)">+ 1/4</button>
            <button class="util-btn" onclick="advanceBeat(4.0)">+ 1å°ç¯€</button>
        </div>

        <div class="note-input-grid">
            <div>
                <label for="inputLane">ãƒ¬ãƒ¼ãƒ³ (1-6)</label>
                <input type="number" id="inputLane" value="1" min="1" max="6">
            </div>
            <div>
                <label for="inputType">ã‚¿ã‚¤ãƒ—</label>
                <select id="inputType" onchange="toggleDuration()">
                    <option value="0">0: Tap (ã‚¿ãƒƒãƒ—)</option>
                    <option value="1">1: Long (ãƒ­ãƒ³ã‚°)</option>
                </select>
            </div>
            <div>
                <label for="inputDurationBeat">é•·ã• (æ‹)</label>
                <input type="number" id="inputDurationBeat" value="2.0" step="0.25" disabled>
            </div>
            <div style="grid-column: 4 / 6;">
                <button onclick="addNoteFromForm()">ãƒãƒ¼ãƒ„ã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>
    
    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã¨ç·¨é›†</h2>
        <div class="input-group" style="align-items: center;">
            <button onclick="clearNotes()" style="background-color: #f0ad4e;">å…¨å‰Šé™¤</button>
            <button onclick="sortNotesAndRefresh()">ã‚½ãƒ¼ãƒˆãƒ»æ›´æ–°</button>
            <span style="margin-left: 20px;">
                <label for="pasteBeat" style="display:inline;">ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹:</label>
                <input type="number" id="pasteBeat" value="8.0" step="0.25" style="width: 80px;">
                <button onclick="pasteNotes()" style="background-color: #1abc9c;">ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ„ã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
            </span>
        </div>
        <div id="noteList">
            </div>
    </div>

    <div id="outputArea">
        <h2>ç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
        <button onclick="generateAndDisplayScore()">ç”Ÿæˆã—ã¦JSONã‚’è¡¨ç¤º</button>
        <button onclick="downloadScore()">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <textarea id="jsonOutput" readonly>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„...</textarea>
    </div>

    <script>
        // --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const NOTE_TYPE_TAP = 0;
        const NOTE_TYPE_LONG = 1;
        
        let currentNotes = []; // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã•ã‚Œã‚‹ãƒãƒ¼ãƒ„ã‚’æ ¼ç´
        let copiedNotes = [];  // ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆç”¨

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        // --- 3. æ‹æ•°ã¨å°ç¯€ã®é€£æº ---

        /** å°ç¯€ã¨æ‹å­å†…æ‹æ•°ã‹ã‚‰çµ¶å¯¾æ‹æ•°ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–° */
        function updateBeatFromMeasure() {
            const measure = parseInt(document.getElementById('inputMeasure').value) || 1;
            const beatInMeasure = parseFloat(document.getElementById('inputBeatInMeasure').value) || 1.0;
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            
            // çµ¶å¯¾æ‹æ•° = (å°ç¯€æ•° - 1) * 1å°ç¯€ã®æ‹æ•° + æ‹å­å†…æ‹æ•°
            const absoluteBeat = (measure - 1) * beatsPerMeasure + beatInMeasure;
            
            document.getElementById('inputBeat').value = round(absoluteBeat, 2);
        }

        /** çµ¶å¯¾æ‹æ•°ã‹ã‚‰å°ç¯€ã¨æ‹å­å†…æ‹æ•°ã‚’è¨ˆç®—ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–° */
        function updateMeasureFromBeat() {
            const absoluteBeat = parseFloat(document.getElementById('inputBeat').value) || 4.0;
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            
            // å°ç¯€æ•° (1å§‹ã¾ã‚Š)
            const measure = Math.floor((absoluteBeat - 1) / beatsPerMeasure) + 1;
            
            // æ‹å­å†…ã®æ‹æ•° (1å§‹ã¾ã‚Š)
            const beatInMeasure = absoluteBeat - (measure - 1) * beatsPerMeasure;
            
            document.getElementById('inputMeasure').value = measure;
            document.getElementById('inputBeatInMeasure').value = round(beatInMeasure, 2);
        }

        /** ç¾åœ¨ã®çµ¶å¯¾æ‹æ•°ã«æŒ‡å®šã—ãŸå·®åˆ†ã‚’åŠ ãˆã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›´æ–° */
        function advanceBeat(delta) {
            const currentBeat = parseFloat(document.getElementById('inputBeat').value);
            document.getElementById('inputBeat').value = round(currentBeat + delta, 2);
            updateMeasureFromBeat();
        }

        // --- 4. ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®ãƒãƒ¼ãƒ„æ“ä½œ ---

        function toggleDuration() {
            const type = document.getElementById('inputType').value;
            const durationInput = document.getElementById('inputDurationBeat');
            durationInput.disabled = (type === String(NOTE_TYPE_TAP));
        }

        function addNoteFromForm() {
            const beat = parseFloat(document.getElementById('inputBeat').value);
            const lane = parseInt(document.getElementById('inputLane').value);
            const type = parseInt(document.getElementById('inputType').value);
            let durationBeats = 0;
            
            if (type === NOTE_TYPE_LONG) {
                durationBeats = parseFloat(document.getElementById('inputDurationBeat').value);
            }

            if (isNaN(beat) || isNaN(lane) || lane < 1 || lane > 6 || (type === NOTE_TYPE_LONG && (isNaN(durationBeats) || durationBeats <= 0))) {
                alert('å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const newNote = { beat, lane, type };
            if (type === NOTE_TYPE_LONG) {
                newNote.duration_beats = durationBeats;
            }
            
            currentNotes.push(newNote);
            sortNotesAndRefresh(); // è¿½åŠ æ™‚ã«ã‚½ãƒ¼ãƒˆ
            
            // æ¬¡ã®å…¥åŠ›ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã€æ‹æ•°ã‚’æ¬¡ã®å…«åˆ†éŸ³ç¬¦ã®ä½ç½®ã«é€²ã‚ã‚‹
            // document.getElementById('inputBeat').value = round(beat + 0.5, 2);
            // updateMeasureFromBeat();
        }

        function clearNotes() {
            if (confirm('å…¨ã¦ã®ãƒãƒ¼ãƒ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                currentNotes = [];
                refreshNoteList();
            }
        }
        
        function sortNotesAndRefresh() {
            currentNotes.sort((a, b) => a.beat - b.beat);
            refreshNoteList();
        }

        // --- 5. ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ ---
        
        /** æŒ‡å®šãƒãƒ¼ãƒ„ã‚’ã‚³ãƒ”ãƒ¼ã—ã€copiedNotesã«æ ¼ç´ */
        function copyNote(index) {
            copiedNotes = [currentNotes[index]]; // å˜ä½“ã‚³ãƒ”ãƒ¼
            alert(`ãƒãƒ¼ãƒ„ (æ‹: ${copiedNotes[0].beat}, ãƒ¬ãƒ¼ãƒ³: ${copiedNotes[0].lane}) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
        }

        /** é¸æŠãƒãƒ¼ãƒ„ç¯„å›²ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ©Ÿèƒ½ (ä»Šå›ã¯å˜ä½“ã‚³ãƒ”ãƒ¼ã«é™å®š)
           * ã‚ˆã‚Šé«˜åº¦ãªã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã¯ã€ã“ã“ã§ç¯„å›²é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
           */
        
        /** ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ„ã‚’ãƒšãƒ¼ã‚¹ãƒˆ */
        function pasteNotes() {
            if (copiedNotes.length === 0) {
                alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            const pasteBeat = parseFloat(document.getElementById('pasteBeat').value);
            if (isNaN(pasteBeat)) {
                alert("ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹ã«æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            // ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ„ã®ãƒªã‚¹ãƒˆå†…ã§æœ€ã‚‚æ—©ã„ãƒãƒ¼ãƒ„ã®æ‹æ•°ã‚’åŸºæº–ã¨ã™ã‚‹
            const minCopiedBeat = copiedNotes.reduce((min, note) => Math.min(min, note.beat), Infinity);
            
            copiedNotes.forEach(copiedNote => {
                // åŸºæº–ã¨ã®å·®åˆ†ã‚’è¨ˆç®—ã—ã€ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹ã«åŠ ãˆã‚‹
                const beatDifference = copiedNote.beat - minCopiedBeat;
                const newBeat = round(pasteBeat + beatDifference, 2);
                
                const newNote = { ...copiedNote, beat: newBeat }; // æ–°ã—ã„æ‹æ•°ã§ãƒãƒ¼ãƒ„ã‚’è¤‡è£½
                
                // duration_beatsãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾å¼•ãç¶™ã
                if (copiedNote.duration_beats) {
                    newNote.duration_beats = copiedNote.duration_beats;
                }
                
                currentNotes.push(newNote);
            });
            
            sortNotesAndRefresh();
            alert(`${copiedNotes.length} å€‹ã®ãƒãƒ¼ãƒ„ã‚’ ${pasteBeat} æ‹ç›®ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸã€‚`);
        }

        // --- 6. ãƒªã‚¹ãƒˆè¡¨ç¤ºã¨æœ€çµ‚å‡ºåŠ› ---

        function refreshNoteList() {
            const listElement = document.getElementById('noteList');
            listElement.innerHTML = '';
            
            if (currentNotes.length === 0) {
                listElement.innerHTML = '<p style="color:#aaa; text-align:center;">ãƒãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            currentNotes.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'note-item';
                
                let durationText = '';
                if (note.type === NOTE_TYPE_LONG) {
                    durationText = ` | é•·ã•: ${note.duration_beats}æ‹`;
                }
                
                // å°ç¯€ã¨æ‹ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
                const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
                const measure = Math.floor((note.beat - 1) / beatsPerMeasure) + 1;
                const beatInMeasure = round(note.beat - (measure - 1) * beatsPerMeasure, 2);


                item.innerHTML = `
                    <span>
                        <strong style="color: #FFD700;">M${measure}.B${beatInMeasure}</strong> (æ‹: ${note.beat}) | 
                        ãƒ¬ãƒ¼ãƒ³: <strong>${note.lane}</strong> | 
                        ã‚¿ã‚¤ãƒ—: ${note.type === NOTE_TYPE_TAP ? 'Tap' : 'Long'}
                        ${durationText}
                    </span>
                    <div>
                        <button class="copy-btn" onclick="copyNote(${index})">ã‚³ãƒ”ãƒ¼</button>
                        <button class="delete-btn" onclick="deleteNote(${index})">å‰Šé™¤</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        function deleteNote(index) {
            currentNotes.splice(index, 1);
            refreshNoteList();
        }

        function generateAndDisplayScore() {
            const title = document.getElementById('title').value;
            const bpm = parseFloat(document.getElementById('bpm').value);
            
            if (isNaN(bpm) || bpm <= 0) {
                alert('BPMã«ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            currentNotes.sort((a, b) => a.beat - b.beat);
            refreshNoteList(); 
            
            const secPerBeat = 60.0 / bpm;

            const finalNotes = currentNotes.map(note => {
                // æ‹æ•°ã‚’ç§’ã«å¤‰æ›
                const time = round(note.beat * secPerBeat, 4);
                let noteObj = {
                    "time": time,
                    "lane": note.lane,
                    "type": note.type
                };
                
                if (note.type === NOTE_TYPE_LONG) {
                    const duration_sec = round(note.duration_beats * secPerBeat, 4);
                    noteObj["duration"] = duration_sec;
                }
                return noteObj;
            });

            const scoreData = {
                "song_title": title,
                "bpm": bpm,
                "notes": finalNotes
            };
            
            const jsonString = JSON.stringify(scoreData, null, 4);
            document.getElementById('jsonOutput').value = jsonString;
        }

        function downloadScore() {
            const jsonString = document.getElementById('jsonOutput').value;
            if (!jsonString || jsonString.includes("ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦")) {
                alert("å…ˆã«ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const title = document.getElementById('title').value.replace(/[^a-z0-9]/gi, '_');
            const filename = `score.json`;
            
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ãƒ•ã‚¡ã‚¤ãƒ« '${filename}' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
        }
        
        // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            toggleDuration();
            updateBeatFromMeasure();
            refreshNoteList();
        });
    </script>

</body>
</html>
