<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿å¯¾å¿œ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        h1, h2 { color: #00FFFF; border-bottom: 1px solid #00FFFF; padding-bottom: 5px; margin-top: 20px; }
        .controls, .editor-area { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .input-group { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;}
        .note-input-grid { display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 10px; align-items: end; margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #00FFFF; color: #1e1e1e; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #00DDDD; }
        .util-btn { padding: 8px 10px; background-color: #6a5acd; color: white; margin-top: 0; }
        .util-btn:hover { background-color: #5a4bba; }
        .edit-mode-btn { background-color: #ffaa00; } 
        .edit-mode-btn:hover { background-color: #e69500; } 

        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-top: 10px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; }
        #noteList { max-height: 250px; overflow-y: auto; background: #3c3c3c; padding: 10px; border-radius: 4px; border: 1px solid #555; }
        .note-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted #555; font-size: 14px; cursor: pointer; }
        .note-item:hover { background-color: #444; } 
        .note-item:last-child { border-bottom: none; }
        .action-group { display: flex; gap: 5px; }
        .delete-btn, .copy-btn { padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-top: 0; }
        .delete-btn { background: #ff4d4d; color: white; }
        .copy-btn { background: #5bc0de; color: white; }
        #hashUrlOutput { background: #3c3c3c; padding: 10px; border-radius: 4px; border: 1px solid #555; overflow-x: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ğŸ¹ éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿å¯¾å¿œ)</h1>
    <div class="controls">
        <h2>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œ</h2>
        <div class="input-group">
            <div>
                <label for="scoreFileInput">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€:</label>
                <input type="file" id="scoreFileInput" accept=".json" onchange="loadScoreFile()">
            </div>
            <div>
                <button onclick="saveToHash()" style="background-color: #2ecc71;">ç¾åœ¨ã®è­œé¢ã‚’URLã«ä¿å­˜ (#)</button>
            </div>
        </div>
        <div id="hashUrlOutput">
            ä¿å­˜ã•ã‚ŒãŸURL: (ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„)
        </div>
    </div>
    
    <div class="controls">
        <h2>åŸºæœ¬æƒ…å ±è¨­å®š</h2>
        <div class="input-group">
            <div>
                <label for="title">æ›²å:</label>
                <input type="text" id="title" value="Enhanced Editor Score">
            </div>
            <div>
                <label for="bpm">BPM:</label>
                <input type="number" id="bpm" value="160.0" step="0.1">
            </div>
            <div>
                <label for="beatsPerMeasure">æ‹å­ (1å°ç¯€ã‚ãŸã‚Šã®æ‹æ•°)</label>
                <input type="number" id="beatsPerMeasure" value="4" min="1" step="1">
            </div>
        </div>
    </div>

    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„è¿½åŠ ãƒ»ç·¨é›†</h2>
        
        <div class="input-group">
            <div>
                <label for="inputMeasure">å°ç¯€ (Measure)</label>
                <input type="number" id="inputMeasure" value="1" min="1" step="1" onchange="updateBeatFromMeasure()">
            </div>
            <div>
                <label for="inputBeatInMeasure">æ‹å­å†…ã®æ‹ (1 - N)</label>
                <input type="number" id="inputBeatInMeasure" value="1.0" min="1" step="0.25" onchange="updateBeatFromMeasure()">
            </div>
            <div style="width: 150px;">
                <label for="inputBeat">çµ¶å¯¾æ‹æ•° (Beat)</label>
                <input type="number" id="inputBeat" value="4.0" step="0.25" onchange="updateMeasureFromBeat()">
            </div>
        </div>
        
        <div class="input-group">
            <button class="util-btn" onclick="advanceBeat(0.25)">+ 1/16</button>
            <button class="util-btn" onclick="advanceBeat(0.5)">+ 1/8</button>
            <button class="util-btn" onclick="advanceBeat(1.0)">+ 1/4</button>
            <button class="util-btn" onclick="advanceBeat(4.0)">+ 1å°ç¯€</button>
        </div>

        <div class="note-input-grid">
            <div>
                <label for="inputLane">ãƒ¬ãƒ¼ãƒ³ (1-6)</label>
                <input type="number" id="inputLane" value="1" min="1" max="6">
            </div>
            <div>
                <label for="inputType">ã‚¿ã‚¤ãƒ—</label>
                <select id="inputType" onchange="toggleDuration()">
                    <option value="0">0: Tap (ã‚¿ãƒƒãƒ—)</option>
                    <option value="1">1: Long (ãƒ­ãƒ³ã‚°)</option>
                </select>
            </div>
            <div>
                <label for="inputDurationBeat">é•·ã• (æ‹)</label>
                <input type="number" id="inputDurationBeat" value="2.0" step="0.25" disabled>
            </div>
            <div style="grid-column: 4 / 6;">
                <button id="addUpdateButton" onclick="handleAddOrUpdateNote()">ãƒãƒ¼ãƒ„ã‚’è¿½åŠ </button>
                <button onclick="cancelEdit()" style="background-color: #666; color: white;" id="cancelEditBtn" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã¨ç·¨é›†</h2>
        <div class="input-group" style="align-items: center;">
            <button onclick="clearNotes()" style="background-color: #f0ad4e;">å…¨å‰Šé™¤</button>
            <button onclick="sortNotesAndRefresh()">ã‚½ãƒ¼ãƒˆãƒ»æ›´æ–°</button>
            <span style="margin-left: 20px;">
                <label for="pasteBeat" style="display:inline;">ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹:</label>
                <input type="number" id="pasteBeat" value="8.0" step="0.25" style="width: 80px;">
                <button onclick="pasteNotes()" style="background-color: #1abc9c;">ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ„ã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
            </span>
        </div>
        <div id="noteList">
            </div>
    </div>

    <div id="outputArea">
        <h2>ç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
        <button onclick="generateAndDisplayScore()">ç”Ÿæˆã—ã¦JSONã‚’è¡¨ç¤º</button>
        <button onclick="downloadScore()">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <textarea id="jsonOutput" readonly>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„...</textarea>
    </div>

    <script>
        // --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const NOTE_TYPE_TAP = 0;
        const NOTE_TYPE_LONG = 1;
        
        let currentNotes = []; // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã•ã‚Œã‚‹ãƒãƒ¼ãƒ„ã‚’æ ¼ç´
        let copiedNotes = [];  // ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆç”¨
        let editingNoteIndex = -1; // -1: è¿½åŠ ãƒ¢ãƒ¼ãƒ‰, 0ä»¥ä¸Š: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

        // --- 3. ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (ãƒãƒƒã‚·ãƒ¥) ---

        /** * ãƒãƒ¼ãƒ„ã¨åŸºæœ¬æƒ…å ±ã‚’åœ§ç¸®ã—ã€URLã®ãƒãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹ 
         * LZString.compressToBase64ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®
         */
        function saveToHash() {
            const dataToSave = {
                title: document.getElementById('title').value,
                bpm: parseFloat(document.getElementById('bpm').value),
                beatsPerMeasure: parseInt(document.getElementById('beatsPerMeasure').value),
                notes: currentNotes 
            };
            
            try {
                const jsonString = JSON.stringify(dataToSave);
                const compressed = LZString.compressToBase64(jsonString);
                
                // URLãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                const newUrl = window.location.origin + window.location.pathname + '#' + compressed;
                window.history.pushState(null, '', newUrl);
                
                document.getElementById('hashUrlOutput').textContent = `ä¿å­˜ã•ã‚ŒãŸURL: ${newUrl}`;
                alert('è­œé¢ãƒ‡ãƒ¼ã‚¿ã‚’URLã«ä¿å­˜ã—ã¾ã—ãŸã€‚ã“ã®URLã‚’å…±æœ‰ã§ãã¾ã™ã€‚');

            } catch(e) {
                console.error("ãƒãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        }

        /**
         * URLã®ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹
         */
        function loadFromHash() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            try {
                const decompressed = LZString.decompressFromBase64(hash);
                if (!decompressed) throw new Error("Decompression failed.");
                
                const loadedData = JSON.parse(decompressed);
                
                if (loadedData.notes && Array.isArray(loadedData.notes)) {
                    // åŸºæœ¬æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
                    document.getElementById('title').value = loadedData.title || 'Loaded Score';
                    document.getElementById('bpm').value = loadedData.bpm || 160.0;
                    document.getElementById('beatsPerMeasure').value = loadedData.beatsPerMeasure || 4;
                    
                    // ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    currentNotes = loadedData.notes;
                    sortNotesAndRefresh();
                    
                    document.getElementById('hashUrlOutput').textContent = `ä¿å­˜ã•ã‚ŒãŸURL: (ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã—ãŸ)`;
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºã®æ›´æ–°
                    updateBeatFromMeasure();
                    toggleDuration();
                    setFormToAddMode();
                    
                    alert('URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰è­œé¢ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                }
            } catch(e) {
                console.error("ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                alert("URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        // --- 4. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ---
        
        /**
         * JSONãƒ•ã‚¡ã‚¤ãƒ« (æ¨™æº–ã®ã‚¹ã‚³ã‚¢å½¢å¼) ã‚’èª­ã¿è¾¼ã¿ã€ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹
         */
        function loadScoreFile() {
            const fileInput = document.getElementById('scoreFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.notes || !Array.isArray(loadedData.notes)) {
                         throw new Error("JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'notes'é…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    
                    // åŸºæœ¬æƒ…å ±ã®ã‚»ãƒƒãƒˆ
                    document.getElementById('title').value = loadedData.song_title || 'File Loaded Score';
                    document.getElementById('bpm').value = loadedData.bpm || 160.0;
                    
                    // ãƒãƒ¼ãƒ„ã‚’BPMãƒ•ãƒªãƒ¼ã®å½¢å¼ (æ‹æ•°ãƒ™ãƒ¼ã‚¹) ã«å¤‰æ›ã—ã€currentNotesã«è¿½åŠ 
                    const loadedBPM = parseFloat(loadedData.bpm) || 160.0;
                    const secPerBeat = 60.0 / loadedBPM;

                    const beatNotes = loadedData.notes.map(note => {
                        const beat = round(note.time / secPerBeat, 2); // ç§’ã‚’æ‹ã«å¤‰æ›
                        let newNote = { beat: beat, lane: note.lane, type: note.type };
                        
                        if (note.type === NOTE_TYPE_LONG && note.duration) {
                            newNote.duration_beats = round(note.duration / secPerBeat, 2); // ç§’ã‚’æ‹ã«å¤‰æ›
                        }
                        return newNote;
                    });
                    
                    // æ—¢å­˜ã®ãƒãƒ¼ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ãƒãƒ¼ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰
                    currentNotes = beatNotes; 
                    sortNotesAndRefresh();
                    alert(`âœ… ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
                    updateBeatFromMeasure();
                    cancelEdit();
                    fileInput.value = ''; // é€£ç¶šèª­ã¿è¾¼ã¿ã«å‚™ãˆã¦ãƒªã‚»ãƒƒãƒˆ
                    
                } catch (error) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                }
            };
            reader.readAsText(file);
        }

        // --- 5. å°ç¯€ãƒ»æ‹æ•°é€£æº (çœç•¥) --- (å¤‰æ›´ãªã—)
        function updateBeatFromMeasure() { /* ... */ }
        function updateMeasureFromBeat() { /* ... */ }
        function advanceBeat(delta) { /* ... */ }
        
        // --- 6. ãƒãƒ¼ãƒ„æ“ä½œ (çœç•¥) --- (å¤‰æ›´ãªã—)
        function toggleDuration() { /* ... */ }
        function getNoteDataFromForm() { /* ... */ }
        function handleAddOrUpdateNote() { /* ... */ }
        function setFormToEditMode(index) { /* ... */ }
        function setFormToAddMode() { /* ... */ }
        function editNote(index) { /* ... */ }
        function cancelEdit() { /* ... */ }
        function clearNotes() { /* ... */ }
        function sortNotesAndRefresh() { /* ... */ }
        function copyNote(index) { /* ... */ }
        function pasteNotes() { /* ... */ }
        function deleteNote(index) { /* ... */ }
        
        // --- 7. ãƒªã‚¹ãƒˆè¡¨ç¤ºã¨æœ€çµ‚å‡ºåŠ› (çœç•¥) --- (ãƒªã‚¹ãƒˆè¡¨ç¤ºéƒ¨åˆ†ã®ã¿ä¸€éƒ¨å¤‰æ›´)
        function refreshNoteList() {
            // ... (ãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯) ...
            const listElement = document.getElementById('noteList');
            listElement.innerHTML = '';
            
            if (currentNotes.length === 0) {
                listElement.innerHTML = '<p style="color:#aaa; text-align:center;">ãƒãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            currentNotes.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'note-item';
                item.onclick = () => editNote(index); 

                let durationText = '';
                if (note.type === NOTE_TYPE_LONG) {
                    durationText = ` | é•·ã•: ${note.duration_beats}æ‹`;
                }
                
                const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
                const measure = Math.floor((note.beat - 1) / beatsPerMeasure) + 1;
                const beatInMeasure = round(note.beat - (measure - 1) * beatsPerMeasure, 2);

                item.innerHTML = `
                    <span>
                        <strong style="color: #FFD700;">M${measure}.B${beatInMeasure}</strong> (æ‹: ${note.beat}) | 
                        ãƒ¬ãƒ¼ãƒ³: <strong>${note.lane}</strong> | 
                        ã‚¿ã‚¤ãƒ—: ${note.type === NOTE_TYPE_TAP ? 'Tap' : 'Long'}
                        ${durationText}
                    </span>
                    <div class="action-group">
                        <button class="copy-btn" onclick="event.stopPropagation(); copyNote(${index});">ã‚³ãƒ”ãƒ¼</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index});">å‰Šé™¤</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }
        
        function generateAndDisplayScore() { /* ... */ }
        function downloadScore() { /* ... */ }
        
        // --- 8. åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            // å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª (lz-string)
            if (typeof LZString === 'undefined') {
                alert("ã‚¨ãƒ©ãƒ¼: LZ-Stringãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }

            loadFromHash(); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€

            // åˆæœŸåŒ–
            toggleDuration();
            updateBeatFromMeasure();
            setFormToAddMode(); 
            refreshNoteList();
        });
    </script>

</body>
</html>
