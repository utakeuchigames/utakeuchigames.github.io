<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (Notemaster v1.2)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        /* CSSã¯çœç•¥ã›ãšã™ã¹ã¦å«ã‚ã¾ã™ */
        body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        h1, h2 { color: #00FFFF; border-bottom: 1px solid #00FFFF; padding-bottom: 5px; margin-top: 20px; }
        .controls, .editor-area { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .input-group { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;}
        .note-input-grid { display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 10px; align-items: end; margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #00FFFF; color: #1e1e1e; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; margin-top: 5px; }
        button:hover { background-color: #00DDDD; }
        .util-btn { padding: 8px 10px; background-color: #6a5acd; color: white; margin-top: 0; }
        .util-btn:hover { background-color: #5a4bba; }
        .edit-mode-btn { background-color: #ffaa00; } 
        .edit-mode-btn:hover { background-color: #e69500; } 

        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #555; background: #3c3c3c; color: #fff; border-radius: 4px; box-sizing: border-box; resize: vertical; margin-top: 10px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; }
        #noteList { max-height: 250px; overflow-y: auto; background: #3c3c3c; padding: 10px; border-radius: 4px; border: 1px solid #555; }
        .note-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted #555; font-size: 14px; cursor: pointer; }
        .note-item:hover { background-color: #444; } 
        .note-item:last-child { border-bottom: none; }
        .action-group { display: flex; gap: 5px; }
        .delete-btn, .copy-btn { padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-top: 0; }
        .delete-btn { background: #ff4d4d; color: white; }
        .copy-btn { background: #5bc0de; color: white; }
        #hashUrlOutput { background: #3c3c3c; padding: 10px; border-radius: 4px; border: 1px solid #555; overflow-x: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
        
        /* === ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å°‚ç”¨CSS (å‹•çš„ã‚µã‚¤ã‚ºå¯¾å¿œ) === */
        .pattern-editor { 
            display: grid; 
            grid-template-columns: 30px repeat(var(--pattern-steps, 16), 1fr); 
            gap: 1px; 
            background: #444; 
            border: 1px solid #555; 
            margin-top: 10px;
            overflow-x: auto; 
        }
        .pattern-header, .pattern-cell { 
            background: #2d2d2d; 
            text-align: center; 
            padding: 5px 0; 
            font-size: 12px;
            user-select: none;
        }
        .pattern-cell { 
            cursor: pointer; 
            background: #1e1e1e;
            transition: background-color 0.1s;
            position: relative;
        }
        .pattern-cell:hover { 
            background: #3c3c3c; 
        }
        .pattern-header { 
            background: #3c3c3c; 
            font-weight: bold; 
            color: #ddd; 
            position: sticky; 
            left: 0;
            z-index: 2;
        }
        .pattern-time { 
            background: #3c3c3c; 
            color: #ddd; 
            font-size: 10px;
            padding: 2px 0;
            grid-column: 2 / calc(var(--pattern-steps, 16) + 2); 
            display: grid;
            grid-template-columns: repeat(var(--pattern-steps, 16), 1fr);
            border-bottom: 1px solid #555;
            position: sticky; 
            top: 0;
            z-index: 1;
        }
        .pattern-time span {
            text-align: center;
        }
        .pattern-time span:nth-child(4n + 1) { 
            background: #555; 
            color: #00FFFF;
        }
        .active-note { 
            background-color: #00FFFF !important; 
            border: 1px solid #fff;
        }
        .active-long-start { 
            background-color: #FFD700 !important; 
            border: 1px solid #fff;
        }
        .active-long-continue { 
            background-color: #FFD700 !important;
            opacity: 0.6;
            border: none;
        }
        .pattern-row { 
            display: contents; 
        }
        .pattern-label { 
            background: #3c3c3c; 
            font-weight: bold; 
            color: #00FFFF;
            padding: 5px 0;
            position: sticky; 
            left: 0;
            z-index: 1;
        }
        .pattern-row:nth-child(even) .pattern-label { color: #FFD700; }
        .pattern-row:nth-child(even) .pattern-cell { background: #151515; }
        
    </style>
</head>
<body>

    <h1>ğŸ¹ éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (Notemaster v1.2)</h1>

    <div class="controls">
        <h2>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œ</h2>
        <div class="input-group">
            <div>
                <label for="scoreFileInput">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€:</label>
                <input type="file" id="scoreFileInput" accept=".json" onchange="loadScoreFile()">
            </div>
            <div>
                <label for="compressedFileInput">LZSåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ« (.txtãªã©) ã‚’èª­ã¿è¾¼ã‚€:</label>
                <input type="file" id="compressedFileInput" accept=".txt,.lzs" onchange="loadCompressedFile()">
            </div>
            <div>
                <button onclick="saveToHash()" style="background-color: #2ecc71;">ç¾åœ¨ã®è­œé¢ã‚’URLã«ä¿å­˜ (#)</button>
            </div>
            <div>
                <button onclick="downloadCompressedFile()" style="background-color: #2980b9;">LZSåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.txt)</button>
            </div>
        </div>
        <div id="hashUrlOutput">
            ä¿å­˜ã•ã‚ŒãŸURL: (ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„)
        </div>
    </div>
    
    <div class="controls">
        <h2>åŸºæœ¬æƒ…å ±è¨­å®š</h2>
        <div class="input-group">
            <div>
                <label for="title">æ›²å:</label>
                <input type="text" id="title" value="Enhanced Editor Score">
            </div>
            <div>
                <label for="bpm">BPM:</label>
                <input type="number" id="bpm" value="160.0" step="0.1">
            </div>
            <div>
                <label for="beatsPerMeasure">æ‹å­ (1å°ç¯€ã‚ãŸã‚Šã®æ‹æ•°)</label>
                <input type="number" id="beatsPerMeasure" value="4" min="1" step="1" onchange="updateBeatFromMeasure();">
            </div>
        </div>
    </div>

    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„è¿½åŠ ãƒ»ç·¨é›† (ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›)</h2>
        
        <div class="input-group">
            <div>
                <label for="inputMeasure">å°ç¯€ (Measure)</label>
                <input type="number" id="inputMeasure" value="1" min="1" step="1" onchange="updateBeatFromMeasure()">
            </div>
            <div>
                <label for="inputBeatInMeasure">æ‹å­å†…ã®æ‹ (1 - N)</label>
                <input type="number" id="inputBeatInMeasure" value="1.0" min="1" step="0.25" onchange="updateBeatFromMeasure()">
            </div>
            <div style="width: 150px;">
                <label for="inputBeat">çµ¶å¯¾æ‹æ•° (Beat)</label>
                <input type="number" id="inputBeat" value="4.0" step="0.25" onchange="updateMeasureFromBeat()">
            </div>
        </div>
        
        <div class="input-group">
            <button class="util-btn" onclick="advanceBeat(0.25)">+ 1/16</button>
            <button class="util-btn" onclick="advanceBeat(0.5)">+ 1/8</button>
            <button class="util-btn" onclick="advanceBeat(1.0)">+ 1/4</button>
            <button class="util-btn" onclick="advanceBeat(4.0)">+ 1å°ç¯€</button>
        </div>

        <div class="note-input-grid">
            <div>
                <label for="inputLane">ãƒ¬ãƒ¼ãƒ³ (1-6)</label>
                <input type="number" id="inputLane" value="1" min="1" max="6">
            </div>
            <div>
                <label for="inputType">ã‚¿ã‚¤ãƒ—</label>
                <select id="inputType" onchange="toggleDuration()">
                    <option value="0">0: Tap (ã‚¿ãƒƒãƒ—)</option>
                    <option value="1">1: Long (ãƒ­ãƒ³ã‚°)</option>
                </select>
            </div>
            <div>
                <label for="inputDurationBeat">é•·ã• (æ‹)</label>
                <input type="number" id="inputDurationBeat" value="2.0" step="0.25" disabled>
            </div>
            <div style="grid-column: 4 / 6;">
                <button id="addUpdateButton" onclick="handleAddOrUpdateNote()">ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ /æ›´æ–°</button>
                <button onclick="cancelEdit()" style="background-color: #666; color: white;" id="cancelEditBtn" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
        
        <h2 style="margin-top: 30px;">ğŸ¹ ãƒãƒ¼ãƒ„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (ç¯„å›²ç·¨é›†å¯¾å¿œ)</h2>
        <div class="input-group">
            <div>
                <label for="startMeasure">é–‹å§‹å°ç¯€ (M)</label>
                <input type="number" id="startMeasure" value="1" min="1" step="1">
            </div>
            <div>
                <label for="endMeasure">çµ‚äº†å°ç¯€ (M)</label>
                <input type="number" id="endMeasure" value="4" min="1" step="1">
            </div>
            <button onclick="loadNotesToPattern()" style="background-color: #3cb371;">ç¯„å›²ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ç·¨é›†</button>
            <button onclick="clearPattern()">ã‚°ãƒªãƒƒãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="input-group" style="align-items: center;">
            <div style="width: 150px;">
                <label for="patternStartBeat">é–‹å§‹æ‹æ•° (è¡¨ç¤º)</label>
                <input type="number" id="patternStartBeat" value="1.0" step="0.25" disabled>
            </div>
            <button onclick="applyPatternToNotes()" style="background-color: #00DDDD;">ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã«åæ˜ </button>
        </div>
        
        <div class="pattern-editor" id="patternEditorGrid">
            <div class="pattern-header">ãƒ¬ãƒ¼ãƒ³</div>
            <div class="pattern-time" id="patternTimeHeader">
                </div>
        </div>
        </div>
    
    <div class="editor-area">
        <h2>ãƒãƒ¼ãƒ„ãƒªã‚¹ãƒˆã¨ç·¨é›†</h2>
        <div class="input-group" style="align-items: center;">
            <button onclick="clearNotes()" style="background-color: #f0ad4e;">å…¨å‰Šé™¤</button>
            <button onclick="sortNotesAndRefresh()">ã‚½ãƒ¼ãƒˆãƒ»æ›´æ–°</button>
            <span style="margin-left: 20px;">
                <label for="pasteBeat" style="display:inline;">ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹:</label>
                <input type="number" id="pasteBeat" value="8.0" step="0.25" style="width: 80px;">
                <button onclick="pasteNotes()" style="background-color: #1abc9c;">ã‚³ãƒ”ãƒ¼ã—ãŸãƒãƒ¼ãƒ„ã‚’ãƒšãƒ¼ã‚¹ãƒˆ</button>
            </span>
        </div>
        <div id="noteList">
            </div>
    </div>

    <div id="outputArea">
        <h2>ç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
        <button onclick="generateAndDisplayScore()">ç”Ÿæˆã—ã¦JSONã‚’è¡¨ç¤º</button>
        <button onclick="downloadScore()">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <textarea id="jsonOutput" readonly>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„...</textarea>
    </div>

    <script>
        // --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const NOTE_TYPE_TAP = 0;
        const NOTE_TYPE_LONG = 1;
        const PATTERN_STEP_BEAT = 0.25; 
        
        const CURRENT_EDITOR_VERSION = "notemasterv.1.2"; 
        
        let currentNotes = []; 
        let copiedNotes = [];  
        let editingNoteIndex = -1;
        
        let currentPattern = []; 
        let patternTotalSteps = 0;
        let patternStartBeat = 1.0;
        let patternEndBeat = 0; 

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒé–¢æ•° (v1ãŒv2ã‚ˆã‚Šæ–°ã—ã„å ´åˆã¯1, å¤ã„å ´åˆã¯-1, åŒã˜å ´åˆã¯0)
        function compareVersions(v1, v2) {
            if (v1 === v2) return 0;
            
            const parseVersion = (v) => {
                // v.X.Y å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è§£æ
                const match = (v || '').match(/v\.(\d+)\.(\d+)/); 
                if (match) {
                    return [parseInt(match[1]), parseInt(match[2])]; 
                }
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒãªã„å ´åˆã¯æœ€å¤ãƒãƒ¼ã‚¸ãƒ§ãƒ³(v.0.0)ã¨è¦‹ãªã™
                return [0, 0];
            };

            const [major1, minor1] = parseVersion(v1);
            const [major2, minor2] = parseVersion(v2);

            if (major1 > major2) return 1;
            if (major1 < major2) return -1;
            
            if (minor1 > minor2) return 1;
            if (minor1 < minor2) return -1;

            return 0; 
        }


        // --- 3. ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (ãƒãƒƒã‚·ãƒ¥/LZSãƒ•ã‚¡ã‚¤ãƒ«) ---
        function getLZSData() {
             return {
                title: document.getElementById('title').value,
                bpm: parseFloat(document.getElementById('bpm').value),
                beatsPerMeasure: parseInt(document.getElementById('beatsPerMeasure').value),
                editor: CURRENT_EDITOR_VERSION, 
                notes: currentNotes 
            };
        }

        function saveToHash() {
            const dataToSave = getLZSData();
            
            try {
                const jsonString = JSON.stringify(dataToSave);
                const compressed = LZString.compressToBase64(jsonString);
                
                const newUrl = window.location.origin + window.location.pathname + '#' + compressed;
                window.history.pushState(null, '', newUrl);
                
                document.getElementById('hashUrlOutput').textContent = `ä¿å­˜ã•ã‚ŒãŸURL: ${newUrl}`;
                alert('è­œé¢ãƒ‡ãƒ¼ã‚¿ã‚’URLã«ä¿å­˜ã—ã¾ã—ãŸã€‚ã“ã®URLã‚’å…±æœ‰ã§ãã¾ã™ã€‚');

            } catch(e) {
                console.error("ãƒãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        }
        
        // â˜… LZSåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function downloadCompressedFile() {
            const dataToSave = getLZSData();
            
            try {
                const jsonString = JSON.stringify(dataToSave);
                const compressedString = LZString.compressToBase64(jsonString);
                
                const title = document.getElementById('title').value.replace(/[^a-z0-9]/gi, '_');
                const filename = `${title}_${CURRENT_EDITOR_VERSION}.txt`;
                
                const blob = new Blob([compressedString], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`âœ… LZSåœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ« '${filename}' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);

            } catch(e) {
                console.error("åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", e);
                alert("åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }


        function loadFromHash() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            try {
                const decompressed = LZString.decompressFromBase64(hash);
                if (!decompressed) throw new Error("Decompression failed.");
                
                const loadedData = JSON.parse(decompressed);
                
                if (loadedData.notes && Array.isArray(loadedData.notes)) {
                    
                    const loadedVersion = loadedData.editor;

                    if (loadedVersion) {
                        const comparisonResult = compareVersions(loadedVersion, CURRENT_EDITOR_VERSION);
                        if (comparisonResult === 1) {
                            alert(`ğŸš¨ èª­ã¿è¾¼ã¿æ‹’å¦: ãƒãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${CURRENT_EDITOR_VERSION}) ã‚ˆã‚Šæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒç ´æã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚èª­ã¿è¾¼ã¿ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚`);
                            return; 
                        } else if (comparisonResult === -1) {
                             alert(`âš ï¸ è­¦å‘Š: ãƒãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                        } 
                    } else {
                        alert(`â„¹ï¸ æƒ…å ±: ãƒãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ã¿ãªã—ã€èª­ã¿è¾¼ã¿ã‚’ç¶šè¡Œã—ã¾ã™ã€‚`);
                    }
                    
                    document.getElementById('title').value = loadedData.title || 'Loaded Score';
                    document.getElementById('bpm').value = loadedData.bpm || 160.0;
                    document.getElementById('beatsPerMeasure').value = loadedData.beatsPerMeasure || 4; 
                    
                    currentNotes = loadedData.notes;
                    sortNotesAndRefresh();
                    
                    document.getElementById('hashUrlOutput').textContent = `ä¿å­˜ã•ã‚ŒãŸURL: (ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã—ãŸ)`;
                    
                    updateBeatFromMeasure();
                    toggleDuration();
                    setFormToAddMode();
                    
                    alert('URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰è­œé¢ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                }
            } catch(e) {
                console.error("ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        // --- 4. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ---
        
        function loadScoreFile() {
            const fileInput = document.getElementById('scoreFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.notes || !Array.isArray(loadedData.notes)) {
                         throw new Error("JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'notes'é…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    
                    const loadedVersion = loadedData.editor;
                    
                    if (loadedVersion) {
                        const comparisonResult = compareVersions(loadedVersion, CURRENT_EDITOR_VERSION);
                        
                        if (comparisonResult === 1) {
                            alert(`ğŸš¨ èª­ã¿è¾¼ã¿æ‹’å¦: èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${CURRENT_EDITOR_VERSION}) ã‚ˆã‚Šæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒç ´æã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚èª­ã¿è¾¼ã¿ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚`);
                            fileInput.value = ''; 
                            return; 
                        } else if (comparisonResult === -1) {
                            alert(`âš ï¸ è­¦å‘Š: èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä¸€éƒ¨ã®æ©Ÿèƒ½ï¼ˆä¾‹: æ‹å­è¨­å®šï¼‰ãŒæ¬ è½ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                        } else {
                            alert(`âœ… èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${CURRENT_EDITOR_VERSION}) ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                        }
                    } else {
                         alert(`â„¹ï¸ æƒ…å ±: èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ã¿ãªã—ã€èª­ã¿è¾¼ã¿ã‚’ç¶šè¡Œã—ã¾ã™ã€‚`);
                    }
                    
                    // JSONãƒ•ã‚¡ã‚¤ãƒ« (å¤–éƒ¨é€£æºç”¨) ã¯timeãƒ™ãƒ¼ã‚¹ãªã®ã§ã€Beatã«å¤‰æ›
                    document.getElementById('title').value = loadedData.song_title || 'File Loaded Score';
                    document.getElementById('bpm').value = loadedData.bpm || 160.0;
                    document.getElementById('beatsPerMeasure').value = loadedData.beatsPerMeasure || 4; 
                    
                    const loadedBPM = parseFloat(loadedData.bpm) || 160.0;
                    const secPerBeat = 60.0 / loadedBPM;

                    const beatNotes = loadedData.notes
                        .filter(note => 
                            note.time !== undefined && 
                            note.lane !== undefined && 
                            note.type !== undefined
                        )
                        .map(note => {
                            const beat = round(note.time / secPerBeat, 2); 
                            let newNote = { beat: beat, lane: note.lane, type: note.type };
                            
                            if (note.type === NOTE_TYPE_LONG && note.duration !== undefined) { 
                                newNote.duration_beats = round(note.duration / secPerBeat, 2); 
                            }
                            return newNote;
                        });
                    
                    currentNotes = beatNotes; 
                    sortNotesAndRefresh();
                    
                    updateBeatFromMeasure();
                    cancelEdit();
                    fileInput.value = ''; 
                    
                } catch (error) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                }
            };
            reader.readAsText(file);
        }

        /**
         * LZSåœ§ç¸®æ–‡å­—åˆ—ãŒæ›¸ã‹ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ (ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«)
         */
        function loadCompressedFile() {
            const fileInput = document.getElementById('compressedFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const compressedString = e.target.result.trim(); 

                    if (!compressedString) {
                         throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ãŒç©ºã§ã™ã€‚");
                    }
                    
                    const decompressed = LZString.decompressFromBase64(compressedString);
                    if (!decompressed) {
                        throw new Error("LZStringã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                    }
                    
                    const loadedData = JSON.parse(decompressed);
                    
                    if (!loadedData.notes || !Array.isArray(loadedData.notes)) {
                         throw new Error("ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'notes'é…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }

                    // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
                    const loadedVersion = loadedData.editor;

                    if (loadedVersion) {
                        const comparisonResult = compareVersions(loadedVersion, CURRENT_EDITOR_VERSION);
                        if (comparisonResult === 1) {
                            alert(`ğŸš¨ èª­ã¿è¾¼ã¿æ‹’å¦: LZSãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${CURRENT_EDITOR_VERSION}) ã‚ˆã‚Šæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒç ´æã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚èª­ã¿è¾¼ã¿ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚`);
                            fileInput.value = ''; 
                            return; 
                        } else if (comparisonResult === -1) {
                            alert(`âš ï¸ è­¦å‘Š: èª­ã¿è¾¼ã‚“ã LZSãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${loadedVersion}) ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ä½œæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                        } else {
                            alert(`âœ… èª­ã¿è¾¼ã‚“ã LZSãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (${CURRENT_EDITOR_VERSION}) ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                        }
                    } else {
                        alert(`â„¹ï¸ æƒ…å ±: èª­ã¿è¾¼ã‚“ã LZSãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ã¿ãªã—ã€èª­ã¿è¾¼ã¿ã‚’ç¶šè¡Œã—ã¾ã™ã€‚`);
                    }

                    // Hashãƒ‡ãƒ¼ã‚¿ã¯Beatæƒ…å ±ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã®ã¾ã¾ä½¿ç”¨
                    document.getElementById('title').value = loadedData.title || 'Compressed File Loaded Score';
                    document.getElementById('bpm').value = loadedData.bpm || 160.0;
                    document.getElementById('beatsPerMeasure').value = loadedData.beatsPerMeasure || 4; 
                    
                    currentNotes = loadedData.notes.filter(note => 
                        note.beat !== undefined && 
                        note.lane !== undefined && 
                        note.type !== undefined
                    ); 
                    
                    sortNotesAndRefresh();
                    
                    updateBeatFromMeasure();
                    cancelEdit();
                    fileInput.value = ''; 
                    
                    alert('âœ… åœ§ç¸®æ–‡å­—åˆ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è­œé¢ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼');
                    
                } catch (error) {
                    alert(`åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error("åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                }
            };
            reader.readAsText(file);
        }


        // --- 5. å°ç¯€ãƒ»æ‹æ•°é€£æº --- 
        function updateBeatFromMeasure() {
            const measure = parseInt(document.getElementById('inputMeasure').value) || 1;
            const beatInMeasure = parseFloat(document.getElementById('inputBeatInMeasure').value) || 1.0;
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            
            const absoluteBeat = (measure - 1) * beatsPerMeasure + beatInMeasure;
            
            document.getElementById('inputBeat').value = round(absoluteBeat, 2);
        }

        function updateMeasureFromBeat() {
            const absoluteBeat = parseFloat(document.getElementById('inputBeat').value) || 4.0;
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            
            const measure = Math.floor((absoluteBeat - 1) / beatsPerMeasure) + 1;
            const beatInMeasure = absoluteBeat - (measure - 1) * beatsPerMeasure;
            
            document.getElementById('inputMeasure').value = measure;
            document.getElementById('inputBeatInMeasure').value = round(beatInMeasure, 2);
        }

        function advanceBeat(delta) {
            const currentBeat = parseFloat(document.getElementById('inputBeat').value);
            document.getElementById('inputBeat').value = round(currentBeat + delta, 2);
            updateMeasureFromBeat();
        }

        // --- 6. ãƒãƒ¼ãƒ„æ“ä½œ ---

        function toggleDuration() {
            const type = document.getElementById('inputType').value;
            const durationInput = document.getElementById('inputDurationBeat');
            durationInput.disabled = (type === String(NOTE_TYPE_TAP));
        }

        function getNoteDataFromForm() {
            const beat = parseFloat(document.getElementById('inputBeat').value);
            const lane = parseInt(document.getElementById('inputLane').value);
            const type = parseInt(document.getElementById('inputType').value);
            let durationBeats = 0;
            
            if (type === NOTE_TYPE_LONG) {
                durationBeats = parseFloat(document.getElementById('inputDurationBeat').value);
            }

            if (isNaN(beat) || isNaN(lane) || lane < 1 || lane > 6 || (type === NOTE_TYPE_LONG && (isNaN(durationBeats) || durationBeats <= 0))) {
                alert('å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return null;
            }

            const noteData = { beat, lane, type };
            if (type === NOTE_TYPE_LONG) {
                noteData.duration_beats = durationBeats;
            }
            return noteData;
        }

        function handleAddOrUpdateNote() {
            const noteData = getNoteDataFromForm();
            if (!noteData) return;

            if (editingNoteIndex === -1) {
                currentNotes.push(noteData);
                document.getElementById('inputBeat').value = round(noteData.beat + 0.5, 2); 
                updateMeasureFromBeat();
                alert('ãƒãƒ¼ãƒ„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
            } else {
                currentNotes[editingNoteIndex] = noteData;
                cancelEdit(); 
                alert('ãƒãƒ¼ãƒ„ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            }
            
            sortNotesAndRefresh(); 
        }

        // --- 7. ç·¨é›†æ©Ÿèƒ½ ---

        function setFormToEditMode(index) {
            editingNoteIndex = index;
            const btn = document.getElementById('addUpdateButton');
            btn.textContent = 'ãƒãƒ¼ãƒ„ã‚’æ›´æ–°';
            btn.classList.add('edit-mode-btn');
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
        }

        function setFormToAddMode() {
            editingNoteIndex = -1;
            const btn = document.getElementById('addUpdateButton');
            btn.textContent = 'ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ /æ›´æ–°';
            btn.classList.remove('edit-mode-btn');
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function editNote(index) {
            const note = currentNotes[index];
            
            document.getElementById('inputBeat').value = note.beat;
            document.getElementById('inputLane').value = note.lane;
            document.getElementById('inputType').value = note.type;
            
            toggleDuration(); 
            
            if (note.type === NOTE_TYPE_LONG) {
                document.getElementById('inputDurationBeat').value = note.duration_beats;
            } else {
                document.getElementById('inputDurationBeat').value = '2.0'; 
            }
            
            updateMeasureFromBeat(); 
            setFormToEditMode(index);
        }

        function cancelEdit() {
            setFormToAddMode();
            document.getElementById('inputBeat').value = '4.0';
            document.getElementById('inputLane').value = '1';
            document.getElementById('inputType').value = '0';
            toggleDuration();
            updateMeasureFromBeat();
        }

        // --- 8. ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ©Ÿèƒ½ ---

        function loadNotesToPattern() {
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            const startMeasure = parseInt(document.getElementById('startMeasure').value) || 1;
            const endMeasure = parseInt(document.getElementById('endMeasure').value) || 4;

            if (startMeasure <= 0 || endMeasure < startMeasure) {
                alert('å°ç¯€ã®ç¯„å›²ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            patternStartBeat = (startMeasure - 1) * beatsPerMeasure + 1.0;
            patternEndBeat = endMeasure * beatsPerMeasure + 1.0;
            
            const totalBeats = patternEndBeat - patternStartBeat;
            patternTotalSteps = round(totalBeats / PATTERN_STEP_BEAT, 0);

            if (patternTotalSteps <= 0) {
                 alert('ç·¨é›†ç¯„å›²ãŒçŸ­ã™ãã‚‹ã‹ã€è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                 return;
            }

            currentPattern = Array(6).fill(0).map(() => Array(patternTotalSteps).fill(null));

            document.getElementById('patternStartBeat').value = patternStartBeat;
            
            let notesLoaded = 0;
            currentNotes.forEach(note => {
                if (note.beat >= patternStartBeat && note.beat < patternEndBeat) {
                    const beatOffset = note.beat - patternStartBeat;
                    const step = round(beatOffset / PATTERN_STEP_BEAT, 0);

                    if (step >= 0 && step < patternTotalSteps) {
                        if (note.type === NOTE_TYPE_TAP) {
                            currentPattern[note.lane - 1][step] = { type: NOTE_TYPE_TAP };
                            notesLoaded++;
                        } else if (note.type === NOTE_TYPE_LONG && note.duration_beats) {
                            const durationSteps = round(note.duration_beats / PATTERN_STEP_BEAT, 0);
                            currentPattern[note.lane - 1][step] = { type: NOTE_TYPE_LONG, duration: note.duration_beats };
                            notesLoaded++;
                            
                            for (let i = 1; i < durationSteps; i++) {
                                const continueStep = step + i;
                                if (continueStep < patternTotalSteps) {
                                    if(currentPattern[note.lane - 1][continueStep] === null) {
                                        currentPattern[note.lane - 1][continueStep] = { type: 2 };
                                    }
                                }
                            }
                        }
                    }
                }
            });

            drawPatternGrid();
            alert(`M${startMeasure}ã€œM${endMeasure}ã®ç¯„å›² (${patternTotalSteps}ã‚¹ãƒ†ãƒƒãƒ—) ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€${notesLoaded}å€‹ã®ãƒãƒ¼ãƒ„ã‚’åæ˜ ã—ã¾ã—ãŸã€‚`);
        }


        function drawPatternGrid() {
            const grid = document.getElementById('patternEditorGrid');
            const timeHeader = document.getElementById('patternTimeHeader');
            const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
            
            grid.style.setProperty('--pattern-steps', patternTotalSteps);

            while (grid.children.length > 2) {
                grid.removeChild(grid.lastElementChild);
            }

            timeHeader.innerHTML = '';
            if (patternTotalSteps > 0) {
                for (let step = 0; step < patternTotalSteps; step++) {
                    const beat = round(patternStartBeat + step * PATTERN_STEP_BEAT, 2);
                    const beatInMeasure = round(((beat - 1) % beatsPerMeasure) + 1, 2);
                    
                    const span = document.createElement('span');
                    if (beatInMeasure === 1.0) {
                        span.textContent = Math.floor(beat); 
                    } else if (step % 4 === 0) {
                        span.textContent = beatInMeasure;
                    }
                    
                    timeHeader.appendChild(span);
                }
            }
            
            for (let lane = 1; lane <= 6; lane++) {
                const label = document.createElement('div');
                label.className = 'pattern-label';
                label.textContent = `L${lane}`;
                grid.appendChild(label);
                
                for (let step = 0; step < patternTotalSteps; step++) {
                    const cell = document.createElement('div');
                    cell.className = 'pattern-cell';
                    cell.dataset.lane = lane;
                    cell.dataset.step = step;

                    if (step % 4 === 0) {
                        cell.style.borderLeft = '1px solid #00FFFF';
                    }

                    const note = currentPattern[lane - 1][step];
                    if (note) {
                        if (note.type === NOTE_TYPE_TAP) {
                            cell.classList.add('active-note'); 
                        } else if (note.type === NOTE_TYPE_LONG) {
                            cell.classList.add('active-long-start'); 
                        } else if (note.type === 2) {
                            cell.classList.add('active-long-continue'); 
                        }
                    }

                    cell.onclick = () => toggleNoteInPattern(lane, step, cell);
                    
                    grid.appendChild(cell);
                }
            }
        }
        
        function toggleNoteInPattern(lane, step, cell) {
            const laneIndex = lane - 1;
            const currentNote = currentPattern[laneIndex][step];
            
            const clearNoteState = () => {
                if (currentNote && currentNote.type === NOTE_TYPE_LONG) {
                    const durationSteps = round(currentNote.duration / PATTERN_STEP_BEAT, 0);
                    for (let i = 0; i < durationSteps; i++) {
                        const targetStep = step + i;
                        if (targetStep < patternTotalSteps) {
                            currentPattern[laneIndex][targetStep] = null;
                            const targetCell = document.querySelector(`.pattern-cell[data-lane="${lane}"][data-step="${targetStep}"]`);
                            if (targetCell) {
                                targetCell.classList.remove('active-long-start', 'active-long-continue', 'active-note');
                            }
                        }
                    }
                } else {
                    cell.classList.remove('active-long-start', 'active-long-continue', 'active-note');
                    currentPattern[laneIndex][step] = null;
                }
            };
            
            if (!currentNote) {
                currentPattern[laneIndex][step] = { type: NOTE_TYPE_TAP };
                cell.classList.add('active-note');
            } else if (currentNote.type === NOTE_TYPE_TAP || currentNote.type === 2) {
                clearNoteState();
                
                const durationBeats = 1.0; 
                const durationSteps = 4;
                
                currentPattern[laneIndex][step] = { type: NOTE_TYPE_LONG, duration: durationBeats };
                cell.classList.add('active-long-start');

                for (let i = 1; i < durationSteps; i++) {
                    const continueStep = step + i;
                    if (continueStep < patternTotalSteps) {
                        if (currentPattern[laneIndex][continueStep] === null) {
                            currentPattern[laneIndex][continueStep] = { type: 2 };
                        }
                        const targetCell = document.querySelector(`.pattern-cell[data-lane="${lane}"][data-step="${continueStep}"]`);
                        if (targetCell) {
                            targetCell.classList.add('active-long-continue');
                        }
                    }
                }
            } else if (currentNote.type === NOTE_TYPE_LONG) {
                clearNoteState();
            }
        }
        
        function applyPatternToNotes() {
            if (patternTotalSteps === 0) {
                alert('å…ˆã«ã€Œç¯„å›²ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ç·¨é›†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ç·¨é›†ç¯„å›²ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const notesToRemove = currentNotes.filter(note => 
                note.beat >= patternStartBeat && note.beat < patternEndBeat
            );
            
            currentNotes = currentNotes.filter(note => 
                note.beat < patternStartBeat || note.beat >= patternEndBeat
            );

            let notesAdded = 0;
            for (let lane = 1; lane <= 6; lane++) {
                for (let step = 0; step < patternTotalSteps; step++) {
                    const note = currentPattern[lane - 1][step];
                    
                    if (note && note.type !== 2) { 
                        const beatOffset = step * PATTERN_STEP_BEAT;
                        const newBeat = round(patternStartBeat + beatOffset, 2);
                        
                        const newNote = { 
                            beat: newBeat, 
                            lane: lane, 
                            type: note.type
                        };

                        if (note.type === NOTE_TYPE_LONG) {
                            newNote.duration_beats = note.duration; 
                        }

                        currentNotes.push(newNote);
                        notesAdded++;
                    }
                }
            }

            if (notesAdded > 0 || notesToRemove.length > 0) {
                sortNotesAndRefresh();
                alert(`ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚${notesToRemove.length}å€‹ã®å¤ã„ãƒãƒ¼ãƒ„ã‚’å‰Šé™¤ã—ã€${notesAdded}å€‹ã®æ–°ã—ã„ãƒãƒ¼ãƒ„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
            } else {
                alert('ãƒãƒ¼ãƒ„ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        function clearPattern() {
            patternTotalSteps = 0; 
            currentPattern = [];
            document.getElementById('patternStartBeat').value = '1.0';
            drawPatternGrid(); 
        }

        // --- 9. ãƒªã‚¹ãƒˆæ“ä½œã¨è¡¨ç¤º ---

        function clearNotes() {
            if (confirm('å…¨ã¦ã®ãƒãƒ¼ãƒ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                currentNotes = [];
                cancelEdit(); 
                refreshNoteList();
            }
        }
        
        function sortNotesAndRefresh() {
            currentNotes.sort((a, b) => a.beat - b.beat);
            refreshNoteList();
        }

        function copyNote(index) {
            copiedNotes = [currentNotes[index]]; 
            alert(`ãƒãƒ¼ãƒ„ (æ‹: ${copiedNotes[0].beat}, ãƒ¬ãƒ¼ãƒ³: ${copiedNotes[0].lane}) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
        }
        
        function pasteNotes() {
            if (copiedNotes.length === 0) {
                alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            const pasteBeat = parseFloat(document.getElementById('pasteBeat').value);
            if (isNaN(pasteBeat)) {
                alert("ãƒšãƒ¼ã‚¹ãƒˆé–‹å§‹æ‹ã«æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            const minCopiedBeat = copiedNotes.reduce((min, note) => Math.min(min, note.beat), Infinity);
            
            copiedNotes.forEach(copiedNote => {
                const beatDifference = copiedNote.beat - minCopiedBeat;
                const newBeat = round(pasteBeat + beatDifference, 2);
                
                const newNote = { 
                    beat: newBeat, 
                    lane: copiedNote.lane, 
                    type: copiedNote.type 
                };
                
                if (copiedNote.duration_beats) {
                    newNote.duration_beats = copiedNote.duration_beats;
                }
                
                currentNotes.push(newNote);
            });
            
            sortNotesAndRefresh();
            alert(`${copiedNotes.length} å€‹ã®ãƒãƒ¼ãƒ„ã‚’ ${pasteBeat} æ‹ç›®ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸã€‚`);
        }

        function refreshNoteList() {
            const listElement = document.getElementById('noteList');
            listElement.innerHTML = '';
            
            if (currentNotes.length === 0) {
                listElement.innerHTML = '<p style="color:#aaa; text-align:center;">ãƒãƒ¼ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            currentNotes.forEach((note, index) => {
                const item = document.createElement('div');
                item.className = 'note-item';
                item.onclick = () => editNote(index); 

                let durationText = '';
                if (note.type === NOTE_TYPE_LONG) {
                    durationText = ` | é•·ã•: ${note.duration_beats}æ‹`;
                }
                
                const beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value) || 4;
                const measure = Math.floor((note.beat - 1) / beatsPerMeasure) + 1;
                const beatInMeasure = round(note.beat - (measure - 1) * beatsPerMeasure, 2);

                item.innerHTML = `
                    <span>
                        <strong style="color: #FFD700;">M${measure}.B${beatInMeasure}</strong> (æ‹: ${note.beat}) | 
                        ãƒ¬ãƒ¼ãƒ³: <strong>${note.lane}</strong> | 
                        ã‚¿ã‚¤ãƒ—: ${note.type === NOTE_TYPE_TAP ? 'Tap' : 'Long'}
                        ${durationText}
                    </span>
                    <div class="action-group">
                        <button class="copy-btn" onclick="event.stopPropagation(); copyNote(${index});">ã‚³ãƒ”ãƒ¼</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index});">å‰Šé™¤</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        function deleteNote(index) {
            if (index === editingNoteIndex) {
                cancelEdit();
            }
            currentNotes.splice(index, 1);
            if (editingNoteIndex > index) {
                editingNoteIndex--;
            }
            refreshNoteList();
        }

        // --- 10. ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (JSON) ---
        function generateAndDisplayScore() {
            const title = document.getElementById('title').value;
            const bpm = parseFloat(document.getElementById('bpm').value);
            
            if (isNaN(bpm) || bpm <= 0) {
                alert('BPMã«ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            currentNotes.sort((a, b) => a.beat - b.beat);
            refreshNoteList(); 
            
            const secPerBeat = 60.0 / bpm;

            const finalNotes = currentNotes.map(note => {
                const time = round(note.beat * secPerBeat, 4);
                let noteObj = {
                    "time": time,
                    "lane": note.lane,
                    "type": note.type
                };
                
                if (note.type === NOTE_TYPE_LONG && note.duration_beats) { 
                    const duration_sec = round(note.duration_beats * secPerBeat, 4);
                    noteObj["duration"] = duration_sec;
                }
                return noteObj;
            });

            const scoreData = {
                "song_title": title,
                "bpm": bpm,
                "editor": CURRENT_EDITOR_VERSION, 
                "beatsPerMeasure": parseInt(document.getElementById('beatsPerMeasure').value), 
                "notes": finalNotes
            };
            
            const jsonString = JSON.stringify(scoreData, null, 4);
            document.getElementById('jsonOutput').value = jsonString;
        }

        function downloadScore() {
            const jsonString = document.getElementById('jsonOutput').value;
            if (!jsonString || jsonString.includes("ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦")) {
                alert("å…ˆã«ã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const title = document.getElementById('title').value.replace(/[^a-z0-9]/gi, '_');
            const filename = `${title}_score.json`;
            
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ãƒ•ã‚¡ã‚¤ãƒ« '${filename}' ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
        }
        
        // --- 11. åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof LZString === 'undefined') {
                console.error("LZ-Stringãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            }

            loadFromHash(); 

            toggleDuration();
            updateBeatFromMeasure();
            setFormToAddMode(); 
            refreshNoteList();
            
            clearPattern(); 
        });
    </script>

</body>
</html>
